<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Login with 2FA</title>
 
  <style>
    /* Add to existing styles.css */
  </style>
</head>
<body>
  <!-- Add this modal structure at the end of container div -->
  <div id="setup-modal" class="setup-modal" style="display: none;">
    <h2>ðŸ”’ Set Up Two-Factor Authentication</h2>
    
    <div class="step-instruction">
      <h3>Step 1: Scan QR Code</h3>
      <div class="qr-container">
        <img id="qr-image" src="" alt="QR Code">
      </div>
      <p>Open your authenticator app (Google Authenticator, Authy, etc.) and scan this QR code.</p>
    </div>

    <div class="step-instruction">
      <h3>Step 2: Manual Entry (Alternative)</h3>
      <p>If you can't scan the QR code, enter this secret key manually:</p>
      <div class="secret-key">
        <span id="secret-key"></span>
        <button class="copy-btn" onclick="copySecretKey()"><i class="far fa-copy"></i></button>
      </div>
    </div>

    <div class="step-instruction">
      <h3>Step 3: Save Backup Codes</h3>
      <div class="backup-codes">
        <p>These codes can be used if you lose access to your authenticator device:</p>
        <div id="backup-codes-list"></div>
        <button onclick="downloadBackupCodes()" class="copy-btn">
          <i class="fas fa-download"></i> Download Codes
        </button>
        <button onclick="copyBackupCodes()" class="copy-btn">
          <i class="far fa-copy"></i> Copy Codes
        </button>
      </div>
    </div>

    <div class="step-instruction">
      <p><strong>Important:</strong></p>
      <ul>
        <li>Store backup codes in a secure location</li>
        <li>Each code can only be used once</li>
        <li>You can generate new codes in your account settings</li>
      </ul>
    </div>

    <button onclick="closeSetupModal()" style="width: 100%; margin-top: 1rem;">
      I've saved my backup codes and set up 2FA
    </button>
  </div>
  <div id="setup-modal-overlay" class="setup-modal-overlay" style="display: none;"></div>

  <script>
    // Add these functions to script.js
    function show2FASetup(data) {
      const modal = document.getElementById('setup-modal');
      const overlay = document.getElementById('setup-modal-overlay');
      
      // Populate data
      document.getElementById('qr-image').src = data.qr_code_base64;
      document.getElementById('secret-key').textContent = data.otp_secret;
      
      const codesList = document.getElementById('backup-codes-list');
      codesList.innerHTML = data.backup_codes.map(code => 
        `<div>${code}</div>`
      ).join('');

      modal.style.display = 'block';
      overlay.style.display = 'block';
    }

    function closeSetupModal() {
      document.getElementById('setup-modal').style.display = 'none';
      document.getElementById('setup-modal-overlay').style.display = 'none';
      window.location.href = '/'; // Redirect to login
    }

    function copySecretKey() {
      const secret = document.getElementById('secret-key').textContent;
      navigator.clipboard.writeText(secret);
      alert('Secret key copied to clipboard!');
    }

    function copyBackupCodes() {
      const codes = [...document.querySelectorAll('#backup-codes-list div')]
                   .map(div => div.textContent).join('\n');
      navigator.clipboard.writeText(codes);
      alert('Backup codes copied to clipboard!');
    }

    function downloadBackupCodes() {
      const codes = [...document.querySelectorAll('#backup-codes-list div')]
                   .map(div => div.textContent).join('\n');
      const blob = new Blob([codes], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'secure-login-backup-codes.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    // Modify registration handler
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      // ... existing registration code ...
      
      if (response.status === 200) {
        show2FASetup(data.data); // Show 2FA setup modal
      }
      // ... error handling ...
    });
  </script>
</body>
</html>